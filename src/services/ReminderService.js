const reminderTemplates = require('../templates/reminderTemplates');

class ReminderService {
    constructor(client, config) {
        this.client = client;
        this.config = config;
        this.recipientNumber = config.whatsapp.recipientNumber;
    }

    async sendReminder(type, customMessage = '') {
        const template = reminderTemplates[type] || customMessage;
        
        try {
            await this.client.sendPresenceAvailable();
            await this.client.sendMessage(this.recipientNumber, template);
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:`, error);
        }
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
    async handleCommand(message) {
        const text = message.toLowerCase().trim();
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        if (text.startsWith('!')) {
            const [command, ...args] = text.slice(1).split(' ');
            await this.executeCommand(command, args);
            return;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
        if (text.includes('—É—Å—Ç–∞–ª') || text.includes('—Å–ø–∞—Ç—å')) {
            await this.sendSleepAdvice();
        } else if (text.includes('–∫—É—à–∞—Ç—å') || text.includes('–≥–æ–ª–æ–¥–µ–Ω')) {
            await this.sendFeedingAdvice();
        } else if (text.includes('–ø–ª–∞—á–µ—Ç') || text.includes('–∫–∞–ø—Ä–∏–∑–Ω–∏—á–∞–µ—Ç')) {
            await this.sendComfortingAdvice();
        } else if (text.includes('—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞')) {
            await this.sendTemperatureAdvice();
        } else if (text.includes('–≥—É–ª—è—Ç—å') || text.includes('–ø—Ä–æ–≥—É–ª–∫–∞')) {
            await this.sendWalkingAdvice();
        } else if (text.includes('–∏–≥—Ä—ã') || text.includes('–∑–∞–Ω—è—Ç–∏—è')) {
            await this.sendActivityAdvice();
        } else if (text.includes('—Ä–∞–∑–≤–∏—Ç–∏–µ')) {
            await this.sendDevelopmentAdvice();
        } else {
            await this.sendHelpMessage();
        }
    }

    // –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏
    async sendTemperatureAdvice() {
        await this.sendReminder('custom', `
üå° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ:

1. –í –∫–æ–º–Ω–∞—Ç–µ:
   ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è: 20-22¬∞C
   ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: 50-70%
   ‚Ä¢ –ü—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
   ‚Ä¢ –ò–∑–±–µ–≥–∞—Ç—å —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤

2. –ö–∞–∫ –æ–¥–µ–≤–∞—Ç—å ${this.config.baby.name}:
   ‚Ä¢ –î–æ–º–∞: 1-2 —Å–ª–æ—è –æ–¥–µ–∂–¥—ã
   ‚Ä¢ –ù–∞ –ø—Ä–æ–≥—É–ª–∫—É: +1 —Å–ª–æ–π –∫ –æ–¥–µ–∂–¥–µ –≤–∑—Ä–æ—Å–ª–æ–≥–æ
   ‚Ä¢ –ù–æ—á—å—é: –ª–µ–≥–∫–∏–π —Å–ø–∞–ª—å–Ω—ã–π –º–µ—à–æ–∫/–ø–∏–∂–∞–º–∞

3. –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø–µ—Ä–µ–≥—Ä–µ–≤–∞:
   ‚Ä¢ –ü–æ—Ç–µ–µ—Ç —à–µ—è –∏ —Å–ø–∏–Ω–∞
   ‚Ä¢ –ö—Ä–∞—Å–Ω—ã–µ —â–µ—á–∫–∏
   ‚Ä¢ –ë–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ
   ‚Ä¢ –ì–æ—Ä—è—á–∏–µ —Ä—É—á–∫–∏

4. –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø–µ—Ä–µ–æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è:
   ‚Ä¢ –•–æ–ª–æ–¥–Ω—ã–π –Ω–æ—Å–∏–∫
   ‚Ä¢ –ë–ª–µ–¥–Ω–æ—Å—Ç—å
   ‚Ä¢ –ü—Ä–æ—Ö–ª–∞–¥–Ω—ã–µ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
   ‚Ä¢ –°–æ–Ω–ª–∏–≤–æ—Å—Ç—å

‚ö†Ô∏è –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö –ª—É—á—à–µ –æ–¥–µ—Ç—å –ª–µ–≥—á–µ –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        `);
    }

    async sendWalkingAdvice() {
        const now = new Date();
        const hour = now.getHours();
        
        let timeAdvice = '';
        if (hour < 11) {
            timeAdvice = '–°–µ–π—á–∞—Å —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏! –ù–µ –∂–∞—Ä–∫–æ –∏ –º–Ω–æ–≥–æ —Å–æ–ª–Ω—Ü–∞ –≤–∏—Ç–∞–º–∏–Ω–∞ D.';
        } else if (hour >= 11 && hour < 16) {
            timeAdvice = '–í —ç—Ç–æ –≤—Ä–µ–º—è –ª—É—á—à–µ –≥—É–ª—è—Ç—å –≤ —Ç–µ–Ω–∏. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä!';
        } else {
            timeAdvice = '–í–µ—á–µ—Ä–Ω—è—è –ø—Ä–æ–≥—É–ª–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –ø–æ–º–æ–∂–µ—Ç –ª—É—á—à–µ —É—Å–Ω—É—Ç—å.';
        }

        await this.sendReminder('custom', `
üå≥ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–≥—É–ª–∫–µ:

‚è∞ ${timeAdvice}

‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≥–æ–¥—É:
   ‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
   ‚Ä¢ –û—Å–∞–¥–∫–∏
   ‚Ä¢ –í–µ—Ç–µ—Ä
   ‚Ä¢ –£–§-–∏–Ω–¥–µ–∫—Å

2. –í–∑—è—Ç—å —Å —Å–æ–±–æ–π:
   ‚Ä¢ –ó–∞–ø–∞—Å–Ω–æ–π –ø–æ–¥–≥—É–∑–Ω–∏–∫
   ‚Ä¢ –í–ª–∞–∂–Ω—ã–µ —Å–∞–ª—Ñ–µ—Ç–∫–∏
   ‚Ä¢ –ü–µ–ª–µ–Ω–∫—É –¥–ª—è –ø–µ–ª–µ–Ω–∞–Ω–∏—è
   ‚Ä¢ –ë—É—Ç—ã–ª–æ—á–∫—É —Å –≤–æ–¥–æ–π
   ‚Ä¢ –õ–µ–≥–∫—É—é –∏–≥—Ä—É—à–∫—É
   ‚Ä¢ –î–æ–∂–¥–µ–≤–∏–∫/—Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫–æ–∑—ã—Ä–µ–∫

3. –û–¥–µ–∂–¥–∞:
   ‚Ä¢ –ü–æ –ø–æ–≥–æ–¥–µ (+1 —Å–ª–æ–π)
   ‚Ä¢ –£–¥–æ–±–Ω–∞—è
   ‚Ä¢ –ù–µ —Å—Ç–µ—Å–Ω—è—é—â–∞—è –¥–≤–∏–∂–µ–Ω–∏—è
   ‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–æ–ª–Ω—Ü–∞/–≤–µ—Ç—Ä–∞

4. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–æ–≥—É–ª–∫–µ:
   ‚Ä¢ –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –ø—Ä–∏—Ä–æ–¥–æ–π
   ‚Ä¢ –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–Ω–∏–µ –¥–µ—Ä–µ–≤—å–µ–≤
   ‚Ä¢ –°–ª—É—à–∞–Ω–∏–µ –∑–≤—É–∫–æ–≤
   ‚Ä¢ –¢–∞–∫—Ç–∏–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è

‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 40-60 –º–∏–Ω—É—Ç
üí° –°–ª–µ–¥–∏—Ç—å –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∞–ª—ã—à–∞
        `);
    }

    async sendActivityAdvice() {
        await this.sendReminder('custom', `
üéØ –†–∞–∑–≤–∏–≤–∞—é—â–∏–µ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è ${this.config.baby.name}:

1. –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ (15-20 –º–∏–Ω—É—Ç):
   ‚Ä¢ –í—ã–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ –Ω–∞ –∂–∏–≤–æ—Ç–∏–∫
   ‚Ä¢ "–í–µ–ª–æ—Å–∏–ø–µ–¥"
   ‚Ä¢ –ü–æ–≤–æ—Ä–æ—Ç—ã –Ω–∞ –±–æ–∫
   ‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ö–≤–∞—Ç–∞–Ω–∏—è

2. –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ (10-15 –º–∏–Ω—É—Ç):
   ‚Ä¢ –†–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã
   ‚Ä¢ –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
   ‚Ä¢ –ó–≤—É–∫–æ–≤—ã–µ –∏–≥—Ä—É—à–∫–∏
   ‚Ä¢ –ù–æ–≤—ã–µ –≤–∫—É—Å—ã –∏ –∑–∞–ø–∞—Ö–∏

3. –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ (–≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è):
   ‚Ä¢ –†–∞–∑–≥–æ–≤–æ—Ä—ã —Å –º–∞–ª—ã—à–æ–º
   ‚Ä¢ –ü–µ—Å–µ–Ω–∫–∏ –∏ –ø–æ—Ç–µ—à–∫–∏
   ‚Ä¢ –ú–∏–º–∏—á–µ—Å–∫–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞
   ‚Ä¢ –ò–≥—Ä—ã "–ö—É-–∫—É"

4. –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ (10-15 –º–∏–Ω—É—Ç):
   ‚Ä¢ –ü–æ–∏—Å–∫ —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã—Ö –∏–≥—Ä—É—à–µ–∫
   ‚Ä¢ –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–Ω–∏–µ –∫–Ω–∏–∂–µ–∫
   ‚Ä¢ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
   ‚Ä¢ –ü—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏

‚ö†Ô∏è –í–∞–∂–Ω–æ:
‚Ä¢ –°–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º
‚Ä¢ –î–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤—ã
‚Ä¢ –•–≤–∞–ª–∏—Ç—å –∑–∞ —É—Å–ø–µ—Ö–∏
‚Ä¢ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å

üí° –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–Ω—è—Ç–∏–π:
‚Ä¢ –ü–æ—Å–ª–µ —Å–Ω–∞
‚Ä¢ –ü–æ—Å–ª–µ –∫–æ—Ä–º–ª–µ–Ω–∏—è (—á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç)
‚Ä¢ –ö–æ–≥–¥–∞ –º–∞–ª—ã—à –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
        `);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    async sendDailySchedule() {
        const schedule = Object.entries(this.config.schedule.dailyRoutine)
            .map(([time, activity]) => `${time} - ${activity.title}`)
            .join('\n');

        await this.sendReminder('custom', `
üìã –†–µ–∂–∏–º –¥–Ω—è ${this.config.baby.name}:

${schedule}

üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
‚Ä¢ !–∫–æ—Ä–º–ª–µ–Ω–∏–µ - —Ä–µ–∂–∏–º –∫–æ—Ä–º–ª–µ–Ω–∏—è
‚Ä¢ !—Å–æ–Ω - —Ä–µ–∂–∏–º —Å–Ω–∞
‚Ä¢ !–∑–∞–Ω—è—Ç–∏—è - –∑–∞–Ω—è—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        `);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∫–æ—Ä–º–ª–µ–Ω–∏–π
    async sendFeedingSchedule() {
        await this.sendReminder('custom', `
üçº –†–µ–∂–∏–º –∫–æ—Ä–º–ª–µ–Ω–∏—è:

‚è∞ –î–Ω–µ–≤–Ω—ã–µ –∫–æ—Ä–º–ª–µ–Ω–∏—è:
${this.config.sleepFeeding.feeding.dailyFeeds.map(time => `‚Ä¢ ${time}`).join('\n')}

üåô –ù–æ—á–Ω—ã–µ –∫–æ—Ä–º–ª–µ–Ω–∏—è:
${this.config.sleepFeeding.feeding.nightFeeds.map(time => `‚Ä¢ ${time}`).join('\n')}

üìä –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ–±—ä–µ–º:
‚Ä¢ –î–µ–Ω—å: ${this.config.sleepFeeding.feeding.portions.day}
‚Ä¢ –ù–æ—á—å: ${this.config.sleepFeeding.feeding.portions.night}

üí° –ò–Ω—Ç–µ—Ä–≤–∞–ª: ${this.config.sleepFeeding.feeding.frequency}
        `);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–Ω–∞
    async sendSleepSchedule() {
        await this.sendReminder('custom', `
üò¥ –†–µ–∂–∏–º —Å–Ω–∞:

‚òÄÔ∏è –î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω:
${this.config.sleepFeeding.sleep.dailyNaps.map(nap => 
    `‚Ä¢ ${nap.time} (${nap.duration})`
).join('\n')}

üåô –ù–æ—á–Ω–æ–π —Å–æ–Ω:
‚Ä¢ –í—Ä–µ–º—è: ${this.config.sleepFeeding.sleep.nightSleep.time}
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${this.config.sleepFeeding.sleep.nightSleep.duration}
‚Ä¢ –ö–æ—Ä–º–ª–µ–Ω–∏—è: ${this.config.sleepFeeding.sleep.nightSleep.feeds}
        `);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π
    async sendActivitiesList() {
        const today = new Date().toLocaleLowerCase('en-US', { weekday: 'monday' });
        const activities = this.config.schedule.weeklyActivities[today];

        if (activities) {
            await this.sendReminder('custom', `
üéØ –ó–∞–Ω—è—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
–§–æ–∫—É—Å: ${activities.focus}

${activities.activities.map(activity => `‚Ä¢ ${activity}`).join('\n')}
            `);
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ–≥—É–ª–∫–µ
    async sendWalkReminder() {
        await this.sendReminder('walkPrep');
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø—Ä–∞–≤–∫–∏
    async sendHelpMessage() {
        await this.sendReminder('custom', `
üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

‚Ä¢ !—Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∂–∏–º –¥–Ω—è
‚Ä¢ !–∫–æ—Ä–º–ª–µ–Ω–∏–µ - —Ä–µ–∂–∏–º –∫–æ—Ä–º–ª–µ–Ω–∏—è
‚Ä¢ !—Å–æ–Ω - —Ä–µ–∂–∏–º —Å–Ω–∞
‚Ä¢ !–∑–∞–Ω—è—Ç–∏—è - –∑–∞–Ω—è—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ !–ø—Ä–æ–≥—É–ª–∫–∞ - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø—Ä–æ–≥—É–ª–∫–µ
‚Ä¢ !–ø–æ–º–æ—â—å - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥

üí° –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ:
‚Ä¢ –ö–æ—Ä–º–ª–µ–Ω–∏–∏
‚Ä¢ –°–Ω–µ
‚Ä¢ –ó–∞–Ω—è—Ç–∏—è—Ö
‚Ä¢ –ü—Ä–æ–≥—É–ª–∫–∞—Ö
        `);
    }
}

module.exports = ReminderService; 